{{- if .Values.patchJob.create -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "open-webui.name" . }}-lb-ip-patch
  namespace: {{ include "open-webui.namespace" . }}
  labels:
    {{- include "open-webui.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 30
  template:
    metadata:
      name: {{ include "open-webui.name" . }}-lb-ip-patch
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name | default (include "open-webui.name" .) }}
      automountServiceAccountToken: true
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e

              # Patch the open-webui service with its LoadBalancer IP
              IP=$(kubectl get secret {{ include "open-webui.name" . }}-secrets -n {{ include "open-webui.namespace" . }} -o jsonpath="{.data.LOAD_BALANCER_IP}" | base64 -d)
              CURRENT_IP=$(kubectl get svc {{ include "open-webui.name" . }} -n {{ include "open-webui.namespace" . }} -o jsonpath="{.spec.loadBalancerIP}" 2>/dev/null || echo "")
              if [[ "$CURRENT_IP" != "$IP" ]]; then
                kubectl patch svc {{ include "open-webui.name" . }} -n {{ include "open-webui.namespace" . }} -p '{"spec":{"loadBalancerIP":"'$IP'"}}' --type=merge
                echo "Service LoadBalancer IP patched to: $IP"
              fi

              # Get vLLM LoadBalancer IP from vllm-app-lb-ip secret
              VLLM_IP=$(kubectl get secret vllm-app-lb-ip -n {{ include "open-webui.namespace" . }} -o jsonpath="{.data.loadBalancerIP}" 2>/dev/null | base64 -d)
              if [[ -z "$VLLM_IP" ]]; then
                echo "ERROR: Failed to read vLLM LB IP from secret vllm-app-lb-ip"
                echo "Available secrets:"
                kubectl get secrets -n {{ include "open-webui.namespace" . }}
                exit 1
              fi
              VLLM_URL="http://${VLLM_IP}:11434"
              echo "vLLM URL: $VLLM_IP"

              # Patch the StatefulSet with OLLAMA_BASE_URLS environment variable (using set env to merge, not replace)
              kubectl set env statefulset/{{ include "open-webui.name" . }} -n {{ include "open-webui.namespace" . }} OLLAMA_BASE_URLS="$VLLM_URL"

              echo "StatefulSet patched with vLLM URL: $VLLM_URL"
{{- end }}
