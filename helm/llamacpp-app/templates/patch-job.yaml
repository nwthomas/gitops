{{- if .Values.patchJob.create -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "server.llama.cpp.fullname" . }}-lb-ip-patch
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "server.llama.cpp.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 30
  template:
    metadata:
      name: {{ include "server.llama.cpp.fullname" . }}-lb-ip-patch
    spec:
      serviceAccountName: {{ include "server.llama.cpp.serviceAccountName" . }}
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              IP=$(kubectl get secret {{ include "server.llama.cpp.fullname" . }}-lb-ip -n {{ .Release.Namespace }} -o jsonpath="{.data.loadBalancerIP}" | base64 -d)
              CURRENT_IP=$(kubectl get svc {{ include "server.llama.cpp.fullname" . }} -n {{ .Release.Namespace }} -o jsonpath="{.spec.loadBalancerIP}" 2>/dev/null || echo "")
              if [[ "$CURRENT_IP" != "$IP" ]]; then
                kubectl patch svc {{ include "server.llama.cpp.fullname" . }} -n {{ .Release.Namespace }} -p '{"spec":{"loadBalancerIP":"'$IP'"}}' --type=merge
              fi
{{- end }}
